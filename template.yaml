AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: |
  Collect resources from AWS accounts

Parameters:
  Domain:
    Type: String
    Description: 'Application Domain'

  System:
    Type: String
    Description: 'Application System'

  Component:
    Type: String
    Description: 'Application Component'

  CodeBranch:
    Type: String
    Description: "Name of deployment branch"

  ClientId:
    Type: String
    Description: "Client ID"
    NoEcho: true

  ClientSecret:
    Type: String
    Description: "Client Secret"
    NoEcho: true

Globals:
  Function:
    Runtime: python3.13
    MemorySize: 128
    Environment:
      Variables:
        POWERTOOLS_SERVICE_NAME: !Ref AWS::StackName


Resources:
  # Functions
  ListAccountsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./src/handlers/ListAccounts
      Handler: function.handler
      Description: List AWS accounts
      Timeout: 15
      Events:
        Schedule:
          Type: ScheduleV2
          Properties:
            ScheduleExpression: rate(15 minutes)
      Policies:
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt ListAccountsSnsTopic.TopicName
        - AWSOrganizationsReadOnlyAccess
      Environment:
        Variables:
          SNS_TOPIC_ARN: !Ref ListAccountsSnsTopic

  ListAccountsSnsTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: ListAccounts Destination

  AddAccountToCatalogFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./src/handlers/AddAccountToCatalog
      Handler: function.handler
      Description: Add account to catalog
      Timeout: 5
      Environment:
        Variables:
          CLIENT_ID: !Ref ClientId
          CLIENT_SECRET: !Ref ClientSecret
      Events:
        Sqs:
          Type: SQS
          Properties:
            Queue: !GetAtt AddAccountToCatalogFunctionSqsQueue.Arn
            BatchSize: 10

  AddAccountToCatalogFunctionSqsQueue:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 120
      MessageRetentionPeriod: 300   # Go away before next invocation of ListAccountsFunction

  AddAccountToCatalogFunctionSnsSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: sqs
      TopicArn: !Ref ListAccountsSnsTopic
      Endpoint: !GetAtt AddAccountToCatalogFunctionSqsQueue.Arn
      RawMessageDelivery: true
